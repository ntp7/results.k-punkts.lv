<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>
        <div class="sponsors"> <img class="dab" src="image/dabai.png">
       <img class="lok" src="image/IMG_3014.png">
       <img class="redc" src="image/IMG_3016.png">
       <img class="org" src="image/IMG_3018.png">
    </div>
<div class="search-container">
    
    <input type="text" id="search-input" class="search-input" placeholder="Meklēt...">
    <div class="info"><div class="k100">K-100 2024</div><img src="image/kpunktslogo.png" alt="Logo" class="logo"></div>
</div>
<table id="participants-table">
    <thead>
        <tr>
            <th class="row-index">Nr.p.k.</th>
            <th id="name-header"><span class="header-container">Vārds <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="surname-header"><span class="header-container">Uzvārds <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="kp1-header"><span class="header-container">KP1 <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="kp2-header"><span class="header-container">KP2 <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="kp3-header"><span class="header-container">KP3 <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="kp4-header"><span class="header-container">KP4 <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="kp5-header"><span class="header-container">KP5 <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
            <th id="laiks-header"><span class="header-container">Laiks <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16l-6-6h12z" fill="currentColor"/></svg></span></th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
    import firebaseConfig from './firebaseconfig.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentSortedColumn = 1; 
    let isAscending = true;

document.addEventListener('DOMContentLoaded', async () => {
    const tableBody = document.querySelector('#participants-table tbody');
    const searchInput = document.getElementById('search-input');

    try {  
        const q = query(collection(db, 'pieteikums100km'), orderBy('submissionTime'));
        const querySnapshot = await getDocs(q);

        let rowIndex = 1;
        querySnapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();

            const formattedkp1 = formatTime(data.KP1, data.izstajies);
            const formattedkp2 = formatTime(data.KP2, data.izstajies);
            const formattedkp3 = formatTime(data.KP3, data.izstajies);
            const formattedkp4 = formatTime(data.KP4, data.izstajies);
            const formattedkp5 = formatTime(data.KP5, data.izstajies);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="row-index">${rowIndex++}</td>
                <td>${data.vards}</td>
                <td>${data.uzvards}</td>
                <td data-kp1="${data.KP1}">${formattedkp1}</td>
                <td data-kp2="${data.KP2}">${formattedkp2}</td>
                <td data-kp3="${data.KP3}">${formattedkp3}</td>
                <td data-kp4="${data.KP4}">${formattedkp4}</td>
                <td data-kp5="${data.KP5}">${formattedkp5}</td>
                <td>${calculateLaiks(data.KP1, data.KP2, data.KP3, data.KP4, data.KP5, data.izstajies)}</td>
            `;
            tableBody.appendChild(row);
        });

        sortTable(1, true); // Initial sort
    } catch (error) {
        console.error("Error getting documents: ", error);
    }

    document.getElementById('name-header').addEventListener('click', () => toggleSort(1));
    document.getElementById('surname-header').addEventListener('click', () => toggleSort(2));
    document.getElementById('kp1-header').addEventListener('click', () => toggleSort(3));
    document.getElementById('kp2-header').addEventListener('click', () => toggleSort(4));
    document.getElementById('kp3-header').addEventListener('click', () => toggleSort(5));
    document.getElementById('kp4-header').addEventListener('click', () => toggleSort(6));
    document.getElementById('kp5-header').addEventListener('click', () => toggleSort(7));
    document.getElementById('laiks-header').addEventListener('click', () => toggleSort(8));

    searchInput.addEventListener('keyup', () => filterTable(searchInput.value));
});

function calculateLaiks(kp1, kp2, kp3, kp4, kp5, izstajies) {
    // Helper: parse "DD/MM/YYYY HH:mm:ss" into Date
    const parseDate = (time) => {
        if (!time) return null;
        const [datePart, timePart] = time.split(" ");
        if (!datePart || !timePart) return null;
        const [day, month, year] = datePart.split("/").map(Number);
        const [hours, minutes, seconds] = timePart.split(":").map(Number);
        return new Date(year, month - 1, day, hours, minutes, seconds);
    };

    // --- If participant did not finish (DNF) ---
    if (izstajies) {
        const start = parseDate(kp1);
        const checkpoints = [kp5, kp4, kp3, kp2, kp1]; // last known checkpoint first
        const lastKP = checkpoints.map(parseDate).find(Boolean); // first valid checkpoint

        if (!start || !lastKP) return `<span class="dnf">DNF</span>`;

        const diffMs = lastKP - start;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

        return `<span class="dnf">DNF</span> <span class="partial">(${hours}h ${minutes}m)</span>`;
    }

    // --- Normal finish (requires kp1 & kp5) ---
    if (!kp1 || !kp5) return "-";
    const start = parseDate(kp1);
    const end = parseDate(kp5);
    if (!start || !end) return "-";

    const diffMs = end - start;
    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    return `${hours}h ${minutes}m`;
}


function toggleSort(columnIndex) {
    isAscending = currentSortedColumn === columnIndex ? !isAscending : true;
    currentSortedColumn = columnIndex;
    sortTable(columnIndex, isAscending);
}

function formatTime(time, izstajies) {
    if (!time && !izstajies) return '-';
    if(!time && izstajies) return 'DNF';
    const parts = time.split(' ')[1]?.split(':');
    if (parts[0].startsWith('0')) return`${parts[0].substring(1)}:${parts[1]}`;
    else return parts ? `${parts[0]}:${parts[1]}` : '-';
}

function sortTable(columnIndex, ascending) {
    const tbody = document.querySelector('#participants-table tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    resetArrows();

    rows.sort((a, b) => {
        let cellA = a.cells[columnIndex].textContent.trim();
        let cellB = b.cells[columnIndex].textContent.trim();

       if (columnIndex >= 3 && columnIndex <= 7) {
    const kpIndex = columnIndex - 2; // KP1 = 1, KP2 = 2, ...
    const rawTimeA = a.cells[columnIndex].getAttribute(`data-kp${kpIndex}`);
    const rawTimeB = b.cells[columnIndex].getAttribute(`data-kp${kpIndex}`);
    return ascending ? compareTimes(rawTimeA, rawTimeB) : compareTimes(rawTimeB, rawTimeA);
}
 else if (columnIndex === 8) {
            return ascending ? compareDuration(cellA, cellB) : compareDuration(cellB, cellA);
        }
        return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });

    rows.forEach(row => tbody.appendChild(row));

    // Recalculate Nr.p.k.
    tbody.querySelectorAll('tr').forEach((row, index) => {
        row.querySelector('.row-index').textContent = index + 1;
    });

    updateArrow(columnIndex, ascending);
}

function compareDuration(timeA, timeB) {
    const parseDuration = (time) => {
        if (!time || time === '-' || time === 'DNF') return Infinity;
        const parts = time.split(' ');
        if (parts.length < 2) return Infinity;
        const hours = parseInt(parts[0]) || 0;
        const minutes = parseInt(parts[1]) || 0;
        return hours * 60 + minutes;
    };
    return parseDuration(timeA) - parseDuration(timeB);
}

function compareTimes(timeA, timeB) {
    if (!timeA || timeA === '-' || timeA === 'DNF') return 1;
    if (!timeB || timeB === '-' || timeB === 'DNF') return -1;
    const parseDate = (time) => {
        const [datePart, timePart] = time.split(" ");
        const [day, month, year] = datePart.split("/").map(Number);
        const [hours, minutes, seconds] = timePart.split(":").map(Number);
        return new Date(year, month - 1, day, hours, minutes, seconds);
    };
    return parseDate(timeA) - parseDate(timeB);
}

function resetArrows() {
    document.querySelectorAll('.arrow').forEach(arrow => {
        arrow.classList.remove('sorted');
        arrow.style.transform = 'scale(1) rotate(0deg)';
    });
}

function updateArrow(columnIndex, ascending) {
    const headers = [
        null, 'name-header', 'surname-header',
        'kp1-header', 'kp2-header',
        'kp3-header', 'kp4-header',
        'kp5-header', 'laiks-header'
    ];
    if (!headers[columnIndex]) return;
    const headerId = headers[columnIndex];
    const arrow = document.querySelector(`#${headerId} .arrow`);
    arrow.classList.add('sorted');
    arrow.style.transform = `scale(1.5) rotate(${ascending ? 0 : 180}deg)`;
}

function filterTable(searchTerm) {
    const rows = document.querySelectorAll('#participants-table tr:not(thead tr)');
    const normalizedSearchTerm = searchTerm.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    rows.forEach(row => {
        const textContent = row.textContent.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        row.style.display = textContent.includes(normalizedSearchTerm) ? '' : 'none';
    });
}
</script>
</html>
